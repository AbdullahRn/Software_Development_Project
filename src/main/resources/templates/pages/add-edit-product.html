<div xmlns:th="http://www.thymeleaf.org" th:fragment="content">

    <div class="message" th:if="${message}" th:text="${message}"></div>
    <div class="error-message" th:if="${error}" th:text="${error}"></div>

    <div class="product-form-page">

        <h1 th:text="${isEditing} ? 'Edit Product' : 'Add Product'">Add Product</h1>

        <form th:action="@{/product/save}"
              method="post"
              enctype="multipart/form-data">

            <input type="hidden" name="id" th:if="${isEditing}" th:value="${product.id}" />

            <div class="form-group">
                <label>Product Name</label>
                <input type="text" name="name" th:value="${product != null ? product.name : ''}" required />
            </div>

            <div class="form-group">
                <label>Sku</label>
                <input type="text" name="sku" th:value="${product != null ? product.sku : ''}" required />
            </div>

            <div class="form-group">
                <label>Stock Quantity</label>
                <input type="number" name="stockQuantity" th:value="${product != null ? product.stockQuantity : ''}" required />
            </div>

            <div class="form-group">
                <label>Price</label>
                <input type="number" step="0.01" name="unitPrice" th:value="${product != null ? product.unitPrice : ''}" required />
            </div>

            <div class="form-group">
                <label>Description</label>
                <textarea name="description" th:text="${product != null ? product.description : ''}"></textarea>
            </div>

            <div class="form-group">
                <label>Category</label>
                <select name="category" required>
                    <option value="">Select a category</option>
                    <option th:each="cat : ${categories}"
                            th:value="${cat.id}"
                            th:text="${cat.name}"
                            th:selected="${product != null and product.category == cat.id}">
                    </option>
                </select>
            </div>

            <div class="form-group">
                <label>Product Image</label>
                <input type="file" name="imageFile" onchange="previewImage(event)"/>

                <img id="previewImg"
                     th:if="${product != null && product.id != null}"
                     th:src="@{'/images/' + ${product.sku} + '.png'}"
                     class="image-preview"
                     alt="preview"
                     style="max-width: 200px; display: block;"/>

                <img id="previewImgEmpty" class="image-preview" alt="preview"
                     style="display:none; max-width: 200px;" />
            </div>

            <button type="submit"
                    th:text="${isEditing} ? 'Update Product' : 'Save Product'">
                Add Product
            </button>

        </form>

    </div>

    <script>
        function previewImage(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                const img = document.getElementById("previewImg");
                const imgEmpty = document.getElementById("previewImgEmpty");

                if (img) {
                    img.src = e.target.result;
                    img.style.display = "block";
                } else {
                    imgEmpty.src = e.target.result;
                    imgEmpty.style.display = "block";
                }
            };
            reader.readAsDataURL(file);
        }
    </script>

</div>